# AgentCore Runtime WebSocket ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ å®Œå…¨è§£èª¬

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯ã€AWS Bedrock AgentCore Runtime ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸéŸ³å£°ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨é€šä¿¡ã™ã‚‹ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®å®Ÿè£…ã‚’ã€åˆå­¦è€…ã§ã‚‚ç†è§£ã§ãã‚‹ã‚ˆã†è©³ç´°ã«è§£èª¬ã—ã¾ã™ã€‚

---

## ç›®æ¬¡

1. [ã“ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯ä½•ã‚’ã™ã‚‹ã®ã‹](#1-ã“ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯ä½•ã‚’ã™ã‚‹ã®ã‹)
2. [å…¨ä½“ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£](#2-å…¨ä½“ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£)
3. [ä½¿ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®è§£èª¬](#3-ä½¿ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®è§£èª¬)
4. [éŸ³å£°ãƒ‡ãƒ¼ã‚¿ã®åŸºç¤çŸ¥è­˜](#4-éŸ³å£°ãƒ‡ãƒ¼ã‚¿ã®åŸºç¤çŸ¥è­˜)
5. [ã‚³ãƒ¼ãƒ‰è©³ç´°è§£èª¬](#5-ã‚³ãƒ¼ãƒ‰è©³ç´°è§£èª¬)
6. [éåŒæœŸå‡¦ç†ã®ä»•çµ„ã¿](#6-éåŒæœŸå‡¦ç†ã®ä»•çµ„ã¿)
7. [ã‚¤ãƒ™ãƒ³ãƒˆå½¢å¼ã®è©³ç´°](#7-ã‚¤ãƒ™ãƒ³ãƒˆå½¢å¼ã®è©³ç´°)
8. [ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°](#8-ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°)

---

## 1. ã“ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯ä½•ã‚’ã™ã‚‹ã®ã‹

### ä¸€è¨€ã§èª¬æ˜ã™ã‚‹ã¨

**ã‚ãªãŸã®ãƒã‚¤ã‚¯ã®å£°ã‚’AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«é€ã‚Šã€AIã®è¿”ç­”ã‚’éŸ³å£°ã§ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ã‹ã‚‰å†ç”Ÿã™ã‚‹**ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§ã™ã€‚

### é›»è©±ã«ä¾‹ãˆã‚‹ã¨

```
ã‚ãªãŸï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼‰          é›»è©±å›ç·šï¼ˆWebSocketï¼‰          AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼ˆã‚µãƒ¼ãƒãƒ¼ï¼‰
      ğŸ“± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ğŸ¤–

   ãƒã‚¤ã‚¯ã§è©±ã™                    å£°ã‚’é€ä¿¡                     å£°ã‚’å—ã‘å–ã‚‹
      â†“                              â†’                            â†“
   éŒ²éŸ³ã™ã‚‹                                                    ç†è§£ã™ã‚‹
      â†“                                                           â†“
   ãƒ‡ãƒ¼ã‚¿ã«å¤‰æ›                                                 è¿”ç­”ã‚’ç”Ÿæˆ
      â†“                              â†                            â†“
   ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ã§èã               è¿”ç­”ã‚’å—ä¿¡                    å£°ã«å¤‰æ›
```

æ™®é€šã®é›»è©±ã¨é•ã†ã®ã¯ã€ç›¸æ‰‹ãŒAIã§ã‚ã‚‹ã“ã¨ã€ãã—ã¦ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆï¼ˆWebSocketï¼‰ã‚’é€šã˜ã¦ã‚„ã‚Šå–ã‚Šã™ã‚‹ã“ã¨ã§ã™ã€‚

---

## 2. å…¨ä½“ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆå›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ã‚ãªãŸã®PCï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼‰                                          â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚   ãƒã‚¤ã‚¯    â”‚ â”€â”€â”€â†’ â”‚ AudioRecorderâ”‚ â”€â”€â”€â†’ â”‚   Queue     â”‚         â”‚
â”‚  â”‚   ğŸ¤        â”‚      â”‚  (éŒ²éŸ³ä¿‚)    â”‚      â”‚ (å¾…ã¡è¡Œåˆ—)  â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                    â”‚                â”‚
â”‚                                                    â†“                â”‚
â”‚                                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚                                            â”‚ send_audio  â”‚         â”‚
â”‚                                            â”‚ (é€ä¿¡ä¿‚)    â”‚         â”‚
â”‚                                            â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                    â”‚                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                     â”‚
                                                     â”‚ WebSocket
                                                     â”‚ (åŒæ–¹å‘é€šä¿¡)
                                                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AWS AgentCore Runtimeï¼ˆã‚µãƒ¼ãƒãƒ¼ï¼‰                                   â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    BidiAgent + Nova Sonic                    â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚   éŸ³å£°å…¥åŠ› â†’ éŸ³å£°èªè­˜(STT) â†’ AIå‡¦ç† â†’ éŸ³å£°åˆæˆ(TTS) â†’ éŸ³å£°å‡ºåŠ›  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                     â”‚
                                                     â”‚ WebSocket
                                                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                    â†“                â”‚
â”‚                                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚                                            â”‚receive_msgs â”‚         â”‚
â”‚                                            â”‚ (å—ä¿¡ä¿‚)    â”‚         â”‚
â”‚                                            â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                    â”‚                â”‚
â”‚                                                    â†“                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼  â”‚ â†â”€â”€â”€ â”‚ AudioPlayer â”‚ â†â”€â”€â”€ â”‚  Base64    â”‚         â”‚
â”‚  â”‚   ğŸ”Š        â”‚      â”‚  (å†ç”Ÿä¿‚)   â”‚      â”‚  ãƒ‡ã‚³ãƒ¼ãƒ‰   â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                                     â”‚
â”‚  ã‚ãªãŸã®PCï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼‰                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¸»è¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®å½¹å‰²

| ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ | å½¹å‰² | ä¾‹ãˆ |
|--------------|------|-----|
| AudioRecorder | ãƒã‚¤ã‚¯ã‹ã‚‰éŸ³å£°ã‚’éŒ²éŸ³ | éŒ²éŸ³ä¿‚ |
| Queue | éŒ²éŸ³ã—ãŸéŸ³å£°ã‚’ä¸€æ™‚ä¿ç®¡ | éƒµä¾¿å—ã‘ |
| send_audio | éŸ³å£°ãƒ‡ãƒ¼ã‚¿ã‚’ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ | é…é”å“¡ |
| WebSocket | ã‚µãƒ¼ãƒãƒ¼ã¨ã®åŒæ–¹å‘é€šä¿¡ | é›»è©±å›ç·š |
| receive_messages | ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’å—ä¿¡ | å—ä»˜ä¿‚ |
| AudioPlayer | å—ä¿¡ã—ãŸéŸ³å£°ã‚’ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ã§å†ç”Ÿ | å†ç”Ÿä¿‚ |

---

## 3. ä½¿ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®è§£èª¬

### ã‚¤ãƒ³ãƒãƒ¼ãƒˆéƒ¨åˆ†

```python
import asyncio          # éåŒæœŸå‡¦ç†ï¼ˆå¾Œè¿°ï¼‰
import websockets       # WebSocketé€šä¿¡
import json             # JSONãƒ‡ãƒ¼ã‚¿ã®å¤‰æ›
import base64           # ãƒã‚¤ãƒŠãƒªâ†”ãƒ†ã‚­ã‚¹ãƒˆå¤‰æ›
import sys              # ã‚·ã‚¹ãƒ†ãƒ æ“ä½œ
import os               # ç’°å¢ƒå¤‰æ•°ã®å–å¾—
import queue            # ã‚¹ãƒ¬ãƒƒãƒ‰é–“ã®ãƒ‡ãƒ¼ã‚¿å—ã‘æ¸¡ã—

from bedrock_agentcore.runtime import AgentCoreRuntimeClient  # AWSèªè¨¼
import pyaudio          # éŸ³å£°å…¥å‡ºåŠ›
```

### å„ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®è§£èª¬

#### asyncioï¼ˆéåŒæœŸå‡¦ç†ï¼‰

**æ™®é€šã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ï¼ˆåŒæœŸå‡¦ç†ï¼‰ã®å•é¡Œç‚¹ï¼š**
```
1. ãƒã‚¤ã‚¯ã‹ã‚‰éŒ²éŸ³ â† çµ‚ã‚ã‚‹ã¾ã§å¾…ã¤
2. ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ â† çµ‚ã‚ã‚‹ã¾ã§å¾…ã¤
3. è¿”ç­”ã‚’å—ä¿¡    â† çµ‚ã‚ã‚‹ã¾ã§å¾…ã¤
4. ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ã§å†ç”Ÿ â† çµ‚ã‚ã‚‹ã¾ã§å¾…ã¤
5. 1ã«æˆ»ã‚‹
```

ã“ã‚Œã ã¨ã€éŒ²éŸ³ä¸­ã¯å—ä¿¡ã§ããªã„ã€å—ä¿¡ä¸­ã¯éŒ²éŸ³ã§ããªã„...ã¨ãªã£ã¦ã—ã¾ã„ã¾ã™ã€‚

**éåŒæœŸå‡¦ç†ãªã‚‰ï¼š**
```
éŒ²éŸ³ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’
     é€ä¿¡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’
          å—ä¿¡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’
               å†ç”Ÿ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’
```

è¤‡æ•°ã®ä½œæ¥­ã‚’ã€ŒåŒæ™‚ã£ã½ãã€é€²ã‚ã‚‰ã‚Œã¾ã™ã€‚å®Ÿéš›ã«ã¯é«˜é€Ÿã«åˆ‡ã‚Šæ›¿ãˆã¦ã„ã‚‹ã ã‘ã§ã™ãŒã€äººé–“ã«ã¯åŒæ™‚ã«å‹•ã„ã¦ã„ã‚‹ã‚ˆã†ã«è¦‹ãˆã¾ã™ã€‚

#### websocketsï¼ˆWebSocketé€šä¿¡ï¼‰

**HTTPã¨ã®é•ã„ï¼š**

```
ã€HTTPï¼ˆæ™®é€šã®Webã‚¢ã‚¯ã‚»ã‚¹ï¼‰ã€‘
ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ: ã€Œãƒ‡ãƒ¼ã‚¿ãã ã•ã„ã€ â†’ ã‚µãƒ¼ãƒãƒ¼
ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ â† ã€Œã¯ã„ã©ã†ãã€    : ã‚µãƒ¼ãƒãƒ¼
ï¼ˆæ¥ç¶šçµ‚äº†ï¼‰

ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ: ã€Œã¾ãŸæ¬²ã—ã„ã€    â†’ ã‚µãƒ¼ãƒãƒ¼
ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ â† ã€Œã¯ã„ã©ã†ãã€    : ã‚µãƒ¼ãƒãƒ¼
ï¼ˆæ¥ç¶šçµ‚äº†ï¼‰

æ¯å›ã€Œæ¥ç¶šâ†’ãƒªã‚¯ã‚¨ã‚¹ãƒˆâ†’ãƒ¬ã‚¹ãƒãƒ³ã‚¹â†’åˆ‡æ–­ã€ã‚’ç¹°ã‚Šè¿”ã™
```

```
ã€WebSocketã€‘
ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ: ã€Œç¹‹ãã£ã±ãªã—ã«ã—ã‚ˆã†ã€ â†’ ã‚µãƒ¼ãƒãƒ¼
ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ â†â†’ ã‚µãƒ¼ãƒãƒ¼ ï¼ˆæ¥ç¶šç¶­æŒï¼‰
ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ: ã€Œãƒ‡ãƒ¼ã‚¿1ã€ â†’
ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ â† ã€Œè¿”ç­”1ã€
ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ: ã€Œãƒ‡ãƒ¼ã‚¿2ã€ â†’
ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ â† ã€Œè¿”ç­”2ã€
...ã„ã¤ã§ã‚‚åŒæ–¹å‘ã«é€å—ä¿¡å¯èƒ½...
ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ: ã€Œçµ‚ã‚ã‚Šã€ â†’
ï¼ˆæ¥ç¶šçµ‚äº†ï¼‰
```

éŸ³å£°é€šè©±ã®ã‚ˆã†ãªãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šä¿¡ã«ã¯WebSocketãŒæœ€é©ã§ã™ã€‚

#### base64ï¼ˆã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ï¼‰

**ãªãœå¿…è¦ã‹ï¼š**

éŸ³å£°ãƒ‡ãƒ¼ã‚¿ã¯**ãƒã‚¤ãƒŠãƒªãƒ‡ãƒ¼ã‚¿**ï¼ˆ0ã¨1ã®ç¾…åˆ—ï¼‰ã§ã™ã€‚
```
éŸ³å£°ãƒ‡ãƒ¼ã‚¿: 0x48 0x65 0x6c 0x6c 0x6f ...ï¼ˆäººé–“ã«ã¯èª­ã‚ãªã„ï¼‰
```

JSONã¯**ãƒ†ã‚­ã‚¹ãƒˆ**ã—ã‹æ‰±ãˆã¾ã›ã‚“ã€‚
```json
{"audio": ã“ã“ã«ãƒã‚¤ãƒŠãƒªã¯å…¥ã‚Œã‚‰ã‚Œãªã„}
```

Base64ã¯ã€ãƒã‚¤ãƒŠãƒªãƒ‡ãƒ¼ã‚¿ã‚’ãƒ†ã‚­ã‚¹ãƒˆï¼ˆA-Z, a-z, 0-9, +, /ï¼‰ã«å¤‰æ›ã—ã¾ã™ï¼š
```
ãƒã‚¤ãƒŠãƒª: 0x48 0x65 0x6c 0x6c 0x6f
   â†“ Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
ãƒ†ã‚­ã‚¹ãƒˆ: "SGVsbG8="
   â†“ JSONã«å…¥ã‚Œã‚‰ã‚Œã‚‹ï¼
{"audio": "SGVsbG8="}
```

**ä¾‹ãˆè©±ï¼š**
è·ç‰©ï¼ˆãƒã‚¤ãƒŠãƒªï¼‰ã‚’éƒµä¾¿ã§é€ã‚ŠãŸã„ãŒã€æ‰‹ç´™ï¼ˆãƒ†ã‚­ã‚¹ãƒˆï¼‰ã—ã‹é€ã‚Œãªã„éƒµä¾¿å±€ã€‚
è·ç‰©ã‚’å†™çœŸã«æ’®ã£ã¦ï¼ˆBase64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ï¼‰æ‰‹ç´™ã«è²¼ã‚Šä»˜ã‘ã¦é€ã‚‹ã€ã¨ã„ã†ã‚¤ãƒ¡ãƒ¼ã‚¸ã€‚

#### pyaudioï¼ˆéŸ³å£°å…¥å‡ºåŠ›ï¼‰

PCã®ãƒã‚¤ã‚¯ã¨ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ã‚’åˆ¶å¾¡ã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚

- **å…¥åŠ›ï¼ˆéŒ²éŸ³ï¼‰**: ãƒã‚¤ã‚¯ã‹ã‚‰ã®éŸ³å£°ã‚’ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§æ‰±ãˆã‚‹ãƒ‡ãƒ¼ã‚¿ã«å¤‰æ›
- **å‡ºåŠ›ï¼ˆå†ç”Ÿï¼‰**: ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ã‹ã‚‰éŸ³ã¨ã—ã¦å‡ºåŠ›

---

## 4. éŸ³å£°ãƒ‡ãƒ¼ã‚¿ã®åŸºç¤çŸ¥è­˜

### éŸ³å£°ã¨ã¯ã€Œç©ºæ°—ã®æŒ¯å‹•ã€

éŸ³ã¯ç©ºæ°—ã®æŒ¯å‹•ã§ã™ã€‚ã“ã®æŒ¯å‹•ã‚’é›»æ°—ä¿¡å·ã«å¤‰æ›ã—ãŸã‚‚ã®ãŒã€Œã‚¢ãƒŠãƒ­ã‚°éŸ³å£°ä¿¡å·ã€ã§ã™ã€‚

```
ç©ºæ°—ã®æŒ¯å‹• â†’ ãƒã‚¤ã‚¯ â†’ é›»æ°—ä¿¡å·ï¼ˆã‚¢ãƒŠãƒ­ã‚°ï¼‰
                           â†‘
                    æ³¢ã®å½¢ã‚’ã—ã¦ã„ã‚‹
```

### ãƒ‡ã‚¸ã‚¿ãƒ«åŒ–ã®ä»•çµ„ã¿

ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã¯ã‚¢ãƒŠãƒ­ã‚°ä¿¡å·ã‚’ç›´æ¥æ‰±ãˆã¾ã›ã‚“ã€‚ãƒ‡ã‚¸ã‚¿ãƒ«åŒ–ï¼ˆæ•°å€¤åŒ–ï¼‰ãŒå¿…è¦ã§ã™ã€‚

```
ã‚¢ãƒŠãƒ­ã‚°ä¿¡å·                    ãƒ‡ã‚¸ã‚¿ãƒ«ä¿¡å·
    ~~~                         â–  â–  â– 
   ~   ~                      â–        â– 
  ~     ~    â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’     â–            â– 
           ã€Œã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã€
           ï¼ˆä¸€å®šé–“éš”ã§å€¤ã‚’å–ã‚‹ï¼‰
```

### ã‚µãƒ³ãƒ—ãƒ«ãƒ¬ãƒ¼ãƒˆï¼ˆSample Rateï¼‰= 16000 Hz

**å®šç¾©**: 1ç§’é–“ã«ä½•å›ã€éŸ³ã®å€¤ã‚’è¨˜éŒ²ã™ã‚‹ã‹

```
1ç§’é–“ã®éŸ³å£°æ³¢å½¢:
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

ã‚µãƒ³ãƒ—ãƒ«ãƒ¬ãƒ¼ãƒˆ 16000Hz ã®å ´åˆ:
1ç§’é–“ã«16000å›ã€å€¤ã‚’è¨˜éŒ²ã™ã‚‹

ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ï¼ˆ16000å€‹ã®ç‚¹ï¼‰
```

**ä¾‹ãˆè©±ï¼š**
ãƒ‘ãƒ©ãƒ‘ãƒ©æ¼«ç”»ã‚’æƒ³åƒã—ã¦ãã ã•ã„ã€‚1ç§’é–“ã«ä½•æšã®çµµã‚’æãã‹ãŒã‚µãƒ³ãƒ—ãƒ«ãƒ¬ãƒ¼ãƒˆã§ã™ã€‚
- 16000Hz = 1ç§’é–“ã«16000æšã®çµµ
- æ•°ãŒå¤šã„ã»ã©æ»‘ã‚‰ã‹ã ãŒã€ãƒ‡ãƒ¼ã‚¿é‡ã‚‚å¢—ãˆã‚‹

**ãªãœ16kHzï¼Ÿ**
- é›»è©±å“è³ª: 8kHz
- FMæ”¾é€: 22kHz
- CDéŸ³è³ª: 44.1kHz
- **éŸ³å£°èªè­˜: 16kHz**ï¼ˆäººã®å£°ã®èªè­˜ã«ååˆ†ãªå“è³ªï¼‰

Nova Sonicã¯16kHzã‚’è¦æ±‚ã—ã¾ã™ã€‚

### ãƒãƒ£ãƒ³ãƒãƒ«ï¼ˆChannelsï¼‰= 1ï¼ˆãƒ¢ãƒãƒ©ãƒ«ï¼‰

**å®šç¾©**: éŸ³å£°ã®çµŒè·¯ã®æ•°

```
ãƒ¢ãƒãƒ©ãƒ« (1ch):    â—â”€â”€â”€â”€â”€â”€â†’ ğŸ”Š
                   1ã¤ã®éŸ³æº

ã‚¹ãƒ†ãƒ¬ã‚ª (2ch):    â—â”€â”€â”€â”€â”€â”€â†’ ğŸ”Šå·¦
                   â—â”€â”€â”€â”€â”€â”€â†’ ğŸ”Šå³
                   2ã¤ã®éŸ³æºï¼ˆå·¦å³ï¼‰
```

éŸ³å£°èªè­˜ã§ã¯ãƒ¢ãƒãƒ©ãƒ«ã§ååˆ†ã§ã™ã€‚ã‚¹ãƒ†ãƒ¬ã‚ªã«ã™ã‚‹ã¨ãƒ‡ãƒ¼ã‚¿é‡ãŒ2å€ã«ãªã‚‹ã ã‘ã€‚

### ãƒ“ãƒƒãƒˆæ·±åº¦ï¼ˆBit Depthï¼‰= 16bit

**å®šç¾©**: 1å›ã®ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã§ã€éŸ³ã®å¤§ãã•ã‚’ä½•æ®µéšã§è¨˜éŒ²ã™ã‚‹ã‹

```
8bit  = 2^8  = 256æ®µéš
16bit = 2^16 = 65536æ®µéš  â† ä»Šå›ä½¿ç”¨
24bit = 2^24 = 16777216æ®µéš
```

**ä¾‹ãˆè©±ï¼š**
çµµã®å…·ã®è‰²æ•°ã¨åŒã˜ã€‚8è‰²ã‚ˆã‚Š65536è‰²ã®æ–¹ãŒã€ç´°ã‹ã„è‰²ã®é•ã„ã‚’è¡¨ç¾ã§ãã‚‹ã€‚
éŸ³ã§è¨€ãˆã°ã€ã€Œã•ã•ã‚„ãå£°ã€ã¨ã€Œå¤§å£°ã€ã®é–“ã‚’ä½•æ®µéšã§è¡¨ç¾ã§ãã‚‹ã‹ã€‚

### PCMï¼ˆPulse Code Modulationï¼‰

**å®šç¾©**: ãƒ‡ã‚¸ã‚¿ãƒ«éŸ³å£°ã®ç”Ÿãƒ‡ãƒ¼ã‚¿å½¢å¼

ã€Œåœ§ç¸®ã—ã¦ã„ãªã„ã€ãã®ã¾ã¾ã®æ•°å€¤ã®ç¾…åˆ—ã€ã®ã“ã¨ã€‚

```
MP3, AACãªã©: åœ§ç¸®ã•ã‚Œã¦ã„ã‚‹ï¼ˆãƒ‡ãƒ¼ã‚¿é‡å°ã€å‡¦ç†å¿…è¦ï¼‰
PCM:         åœ§ç¸®ãªã—ï¼ˆãƒ‡ãƒ¼ã‚¿é‡å¤§ã€ãã®ã¾ã¾ä½¿ãˆã‚‹ï¼‰
```

Nova Sonicã¯PCMå½¢å¼ã‚’è¦æ±‚ã—ã¾ã™ã€‚

### ãƒãƒ£ãƒ³ã‚¯ã‚µã‚¤ã‚ºï¼ˆChunk Sizeï¼‰= 512

**å®šç¾©**: ä¸€åº¦ã«å‡¦ç†ã™ã‚‹éŸ³å£°ãƒ‡ãƒ¼ã‚¿ã®å˜ä½ï¼ˆãƒ•ãƒ¬ãƒ¼ãƒ æ•°ï¼‰

```
16kHz, 512ãƒ•ãƒ¬ãƒ¼ãƒ ã®å ´åˆ:
512 Ã· 16000 = 0.032ç§’ = 32ãƒŸãƒªç§’åˆ†ã®éŸ³å£°

ã¤ã¾ã‚Šã€32ãƒŸãƒªç§’ã”ã¨ã«éŸ³å£°ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã™ã‚‹
```

**ä¾‹ãˆè©±ï¼š**
æ‰‹ç´™ã‚’1æ–‡å­—ãšã¤é€ã‚‹ã‹ã€1ãƒšãƒ¼ã‚¸ãšã¤é€ã‚‹ã‹ã®é•ã„ã€‚
- å°ã•ã™ãã‚‹: é€ä¿¡å›æ•°ãŒå¢—ãˆã¦åŠ¹ç‡ãŒæ‚ªã„
- å¤§ãã™ãã‚‹: é…å»¶ãŒç™ºç”Ÿã™ã‚‹ï¼ˆæºœã¾ã‚‹ã¾ã§å¾…ã¤ã‹ã‚‰ï¼‰
- 512ã¯è‰¯ã„ãƒãƒ©ãƒ³ã‚¹

### ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚ºã®è¨ˆç®—

```
1ç§’é–“ã®ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚º:
= ã‚µãƒ³ãƒ—ãƒ«ãƒ¬ãƒ¼ãƒˆ Ã— ãƒãƒ£ãƒ³ãƒãƒ«æ•° Ã— (ãƒ“ãƒƒãƒˆæ·±åº¦ Ã· 8)
= 16000 Ã— 1 Ã— (16 Ã· 8)
= 16000 Ã— 1 Ã— 2
= 32000ãƒã‚¤ãƒˆ
= ç´„32KB/ç§’
```

1åˆ†é–“ã®é€šè©±ã§ç´„1.9MBã€10åˆ†ã§ç´„19MBã®ãƒ‡ãƒ¼ã‚¿ãŒé€å—ä¿¡ã•ã‚Œã¾ã™ã€‚

---

## 5. ã‚³ãƒ¼ãƒ‰è©³ç´°è§£èª¬

### 5.1 ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªè¨­å®š

```python
# ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªè¨­å®š
# Nova Sonicã¯å…¥å‡ºåŠ›ã¨ã‚‚ã«16kHz
SAMPLE_RATE = 16000        # 16kHz
INPUT_SAMPLE_RATE = SAMPLE_RATE
OUTPUT_SAMPLE_RATE = SAMPLE_RATE
CHANNELS = 1               # ãƒ¢ãƒãƒ©ãƒ«
CHUNK_SIZE = 512           # ãƒ•ãƒ¬ãƒ¼ãƒ ã‚µã‚¤ã‚º
FORMAT = pyaudio.paInt16   # 16bit PCM
```

| è¨­å®š | å€¤ | æ„å‘³ |
|-----|-----|-----|
| SAMPLE_RATE | 16000 | 1ç§’é–“ã«16000å›ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚° |
| CHANNELS | 1 | ãƒ¢ãƒãƒ©ãƒ«ï¼ˆ1ãƒãƒ£ãƒ³ãƒãƒ«ï¼‰ |
| CHUNK_SIZE | 512 | ä¸€åº¦ã«512ãƒ•ãƒ¬ãƒ¼ãƒ å‡¦ç†ï¼ˆç´„32msåˆ†ï¼‰ |
| FORMAT | paInt16 | 16ãƒ“ãƒƒãƒˆæ•´æ•°ã§ã‚µãƒ³ãƒ—ãƒ«å€¤ã‚’è¡¨ç¾ |

**é‡è¦**: ã‚µãƒ¼ãƒãƒ¼ï¼ˆNova Sonicï¼‰ã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§ã“ã‚Œã‚‰ã®è¨­å®šãŒä¸€è‡´ã—ã¦ã„ãªã„ã¨ã€
- éŸ³ãŒé€Ÿããªã‚‹/é…ããªã‚‹
- éŸ³ãŒé«˜ããªã‚‹/ä½ããªã‚‹
- ãƒã‚¤ã‚ºã ã‚‰ã‘ã«ãªã‚‹

ã¨ã„ã£ãŸå•é¡ŒãŒç™ºç”Ÿã—ã¾ã™ã€‚

### 5.2 AudioPlayer ã‚¯ãƒ©ã‚¹ï¼ˆéŸ³å£°å†ç”Ÿï¼‰

```python
class AudioPlayer:
    """å—ä¿¡ã—ãŸéŸ³å£°ãƒ‡ãƒ¼ã‚¿ã‚’å†ç”Ÿã™ã‚‹ã‚¯ãƒ©ã‚¹"""

    def __init__(self, sample_rate: int = OUTPUT_SAMPLE_RATE):
        if not PYAUDIO_AVAILABLE:
            return

        self.pa = pyaudio.PyAudio()  # PyAudioã®åˆæœŸåŒ–
        self._sample_rate = sample_rate
        self.stream = self.pa.open(
            format=FORMAT,           # 16bit
            channels=CHANNELS,       # ãƒ¢ãƒãƒ©ãƒ«
            rate=sample_rate,        # 16kHz
            output=True,             # å‡ºåŠ›ï¼ˆå†ç”Ÿï¼‰ãƒ¢ãƒ¼ãƒ‰
            frames_per_buffer=CHUNK_SIZE * 2  # ãƒãƒƒãƒ•ã‚¡ã‚µã‚¤ã‚º
        )
        self._running = True
```

#### å„è¡Œã®è§£èª¬

**`self.pa = pyaudio.PyAudio()`**

PyAudioãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’åˆæœŸåŒ–ã—ã¾ã™ã€‚PCã®ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã‚·ã‚¹ãƒ†ãƒ ã¨æ¥ç¶šã™ã‚‹æº–å‚™ã€‚

**`self.pa.open(...)`**

ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ã¸ã®ã€Œãƒ‘ã‚¤ãƒ—ã€ã‚’é–‹ãã¾ã™ã€‚

```
               self.stream
ãƒ—ãƒ­ã‚°ãƒ©ãƒ  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ ğŸ”Š
           ï¼ˆãƒ‡ãƒ¼ã‚¿ã‚’æµã™ï¼‰
```

**`output=True`**

ã€Œå‡ºåŠ›ãƒ¢ãƒ¼ãƒ‰ã€ã‚’æŒ‡å®šã€‚`input=True`ãªã‚‰ã€Œå…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ï¼ˆéŒ²éŸ³ï¼‰ã€ã«ãªã‚‹ã€‚

**`frames_per_buffer=CHUNK_SIZE * 2`**

ãƒãƒƒãƒ•ã‚¡ï¼ˆä¸€æ™‚ä¿ç®¡å ´æ‰€ï¼‰ã®ã‚µã‚¤ã‚ºã€‚å¤§ãã‚ã«ã™ã‚‹ã“ã¨ã§éŸ³é£›ã³ã‚’é˜²ãã€‚

```
ãƒ‡ãƒ¼ã‚¿ â†’ [ãƒãƒƒãƒ•ã‚¡ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ] â†’ ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼

ãƒãƒƒãƒ•ã‚¡ãŒå°ã•ã„ã¨:
ãƒ‡ãƒ¼ã‚¿ â†’ [ãƒ â–ˆâ–ˆ] â†’ ç©ºã£ã½ï¼ â†’ éŸ³ãŒé€”åˆ‡ã‚Œã‚‹

ãƒãƒƒãƒ•ã‚¡ãŒå¤§ãã„ã¨:
ãƒ‡ãƒ¼ã‚¿ â†’ [ãƒãƒƒãƒ•ã‚¡ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ] â†’ å®‰å®šã—ã¦å†ç”Ÿ
         ï¼ˆå°‘ã—é…å»¶ã™ã‚‹ãŒé€”åˆ‡ã‚Œãªã„ï¼‰
```

#### play ãƒ¡ã‚½ãƒƒãƒ‰

```python
def play(self, audio_bytes: bytes):
    """éŸ³å£°ãƒ‡ãƒ¼ã‚¿ã‚’å†ç”Ÿ"""
    if not PYAUDIO_AVAILABLE or not self._running:
        return
    try:
        self.stream.write(audio_bytes)  # ãƒã‚¤ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ã‚¹ãƒˆãƒªãƒ¼ãƒ ã«æ›¸ãè¾¼ã‚€
    except Exception as e:
        print(f"[AudioPlayer] Error: {e}")
```

`stream.write(audio_bytes)` ãŒå®Ÿéš›ã«éŸ³ã‚’é³´ã‚‰ã™éƒ¨åˆ†ã€‚
ãƒã‚¤ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’æ¸¡ã™ã¨ã€ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ã‹ã‚‰éŸ³ãŒå‡ºã‚‹ã€‚

#### stop ãƒ¡ã‚½ãƒƒãƒ‰

```python
def stop(self):
    """å†ç”Ÿã‚’åœæ­¢"""
    self._running = False
    if PYAUDIO_AVAILABLE:
        try:
            self.stream.stop_stream()  # ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’åœæ­¢
            self.stream.close()        # ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’é–‰ã˜ã‚‹
            self.pa.terminate()        # PyAudioã‚’çµ‚äº†
        except Exception:
            pass
```

ãƒªã‚½ãƒ¼ã‚¹ã®å¾Œç‰‡ä»˜ã‘ã€‚ã“ã‚Œã‚’ã—ãªã„ã¨ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ã‚„æ¬¡å›èµ·å‹•æ™‚ã®ã‚¨ãƒ©ãƒ¼ã®åŸå› ã«ãªã‚‹ã€‚

### 5.3 AudioRecorder ã‚¯ãƒ©ã‚¹ï¼ˆéŸ³å£°éŒ²éŸ³ï¼‰

```python
class AudioRecorder:
    """ãƒã‚¤ã‚¯ã‹ã‚‰éŸ³å£°ã‚’éŒ²éŸ³ã™ã‚‹ã‚¯ãƒ©ã‚¹"""

    def __init__(self):
        if not PYAUDIO_AVAILABLE:
            return

        self.pa = pyaudio.PyAudio()
        self.audio_queue = queue.Queue()  # éŸ³å£°ãƒ‡ãƒ¼ã‚¿ã®å¾…ã¡è¡Œåˆ—
        self._running = False
        self._stream = None
```

#### Queueï¼ˆã‚­ãƒ¥ãƒ¼ï¼‰ã¨ã¯

```
          è¿½åŠ                               å–ã‚Šå‡ºã—
æ–°ãƒ‡ãƒ¼ã‚¿ â†’ [D] [C] [B] [A] â†’ å¤ã„ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å–ã‚Šå‡ºã™

First In, First Outï¼ˆFIFOï¼‰: å…ˆã«å…¥ã‚ŒãŸã‚‚ã®ãŒå…ˆã«å‡ºã‚‹
```

**ä¾‹ãˆè©±ï¼š**
ã‚³ãƒ³ãƒ“ãƒ‹ã®ãƒ¬ã‚¸ã®åˆ—ã€‚å…ˆã«ä¸¦ã‚“ã äººãŒå…ˆã«ä¼šè¨ˆã™ã‚‹ã€‚
éŒ²éŸ³ã—ãŸéŸ³å£°ã‚‚ã€å…ˆã«éŒ²éŸ³ã—ãŸã‚‚ã®ã‹ã‚‰é †ã«é€ä¿¡ã™ã‚‹ã€‚

#### ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°

```python
def _audio_callback(self, in_data, frame_count, time_info, status):
    """PyAudioã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆåˆ¥ã‚¹ãƒ¬ãƒƒãƒ‰ã§å®Ÿè¡Œï¼‰"""
    if self._running:
        self.audio_queue.put(in_data)  # éŒ²éŸ³ãƒ‡ãƒ¼ã‚¿ã‚’ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ 
    return (None, pyaudio.paContinue)  # éŒ²éŸ³ã‚’ç¶šã‘ã‚‹
```

**ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã¯ï¼š**

ã€Œâ—‹â—‹ãŒèµ·ããŸã‚‰ã€ã“ã®é–¢æ•°ã‚’å‘¼ã‚“ã§ã­ã€ã¨ã„ã†ä»•çµ„ã¿ã€‚

```
é€šå¸¸ã®å‡¦ç†:
ãƒ—ãƒ­ã‚°ãƒ©ãƒ : ã€ŒéŒ²éŸ³ã—ã¦ã€
ãƒã‚¤ã‚¯:     ã€Œ...éŒ²éŸ³ä¸­...ã€
ãƒ—ãƒ­ã‚°ãƒ©ãƒ : ã€Œå¾…ã£ã¦ã‚‹...ã€ï¼ˆãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã‚‹ï¼‰
ãƒã‚¤ã‚¯:     ã€Œã§ããŸï¼ã€
ãƒ—ãƒ­ã‚°ãƒ©ãƒ : ã€Œã‚„ã£ã¨ç¶šããŒã§ãã‚‹ã€

ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯:
ãƒ—ãƒ­ã‚°ãƒ©ãƒ : ã€ŒéŒ²éŸ³ã—ã¦ã€‚ã§ããŸã‚‰ã“ã®é–¢æ•°å‘¼ã‚“ã§ã€
ãƒã‚¤ã‚¯:     ã€Œäº†è§£ã€
ãƒ—ãƒ­ã‚°ãƒ©ãƒ : ã€Œä»–ã®ä»•äº‹ã—ã‚ˆã†ã€ï¼ˆãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œãªã„ï¼‰
ãƒã‚¤ã‚¯:     ã€Œã§ããŸï¼é–¢æ•°å‘¼ã¶ã­ã€â†’ _audio_callbackå®Ÿè¡Œ
```

**å¼•æ•°ã®æ„å‘³ï¼š**
- `in_data`: éŒ²éŸ³ã•ã‚ŒãŸéŸ³å£°ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒã‚¤ãƒˆåˆ—ï¼‰
- `frame_count`: éŒ²éŸ³ã•ã‚ŒãŸãƒ•ãƒ¬ãƒ¼ãƒ æ•°
- `time_info`: ã‚¿ã‚¤ãƒŸãƒ³ã‚°æƒ…å ±ï¼ˆé€šå¸¸ã¯ä½¿ã‚ãªã„ï¼‰
- `status`: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ãƒ©ã‚°ï¼ˆã‚¨ãƒ©ãƒ¼æ¤œå‡ºç”¨ï¼‰

**æˆ»ã‚Šå€¤ï¼š**
- `(None, pyaudio.paContinue)`: å‡ºåŠ›ãƒ‡ãƒ¼ã‚¿ãªã—ã€éŒ²éŸ³ç¶šè¡Œ

#### start ãƒ¡ã‚½ãƒƒãƒ‰

```python
def start(self):
    """éŒ²éŸ³ã‚’é–‹å§‹"""
    if not PYAUDIO_AVAILABLE:
        return

    self._running = True
    self._stream = self.pa.open(
        format=FORMAT,
        channels=CHANNELS,
        rate=INPUT_SAMPLE_RATE,
        input=True,                        # å…¥åŠ›ï¼ˆéŒ²éŸ³ï¼‰ãƒ¢ãƒ¼ãƒ‰
        frames_per_buffer=CHUNK_SIZE,
        stream_callback=self._audio_callback  # ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã‚’ç™»éŒ²
    )
    self._stream.start_stream()  # éŒ²éŸ³é–‹å§‹
```

`input=True` ã§éŒ²éŸ³ãƒ¢ãƒ¼ãƒ‰ã€`stream_callback` ã§ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã‚’ç™»éŒ²ã€‚

#### get_audio_chunk ãƒ¡ã‚½ãƒƒãƒ‰

```python
def get_audio_chunk(self) -> bytes | None:
    """ã‚­ãƒ¥ãƒ¼ã‹ã‚‰éŸ³å£°ãƒãƒ£ãƒ³ã‚¯ã‚’å–å¾—ï¼ˆãƒãƒ³ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ï¼‰"""
    try:
        return self.audio_queue.get_nowait()  # å¾…ãŸãšã«å–å¾—
    except queue.Empty:
        return None  # ã‚­ãƒ¥ãƒ¼ãŒç©ºãªã‚‰ None ã‚’è¿”ã™
```

**ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚° vs ãƒãƒ³ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ï¼š**

```
ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ï¼ˆget()ï¼‰:
ã€Œãƒ‡ãƒ¼ã‚¿ãã ã•ã„ã€â†’ ãƒ‡ãƒ¼ã‚¿ãŒãªã„ã¨å¾…ã¡ç¶šã‘ã‚‹

ãƒãƒ³ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ï¼ˆget_nowait()ï¼‰:
ã€Œãƒ‡ãƒ¼ã‚¿ãã ã•ã„ã€â†’ ãªã„ãªã‚‰ã€Œãªã„ã€ã¨ã™ãè¿”äº‹
```

ãƒãƒ³ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ã«ã™ã‚‹ã“ã¨ã§ã€ä»–ã®å‡¦ç†ï¼ˆå—ä¿¡ãªã©ï¼‰ã‚’å¦¨ã’ãªã„ã€‚

### 5.4 WebSocket æ¥ç¶šã®ç¢ºç«‹

```python
def get_websocket_connection(region: str, runtime_arn: str):
    """AgentCore Runtimeã¸ã®WebSocketæ¥ç¶šæƒ…å ±ã‚’å–å¾—"""
    client = AgentCoreRuntimeClient(region=region)
    ws_url, headers = client.generate_ws_connection(runtime_arn=runtime_arn)
    return ws_url, headers
```

#### SigV4 èªè¨¼ã¨ã¯

AWSã®ã‚µãƒ¼ãƒ“ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã«ã¯èªè¨¼ãŒå¿…è¦ã§ã™ã€‚
`AgentCoreRuntimeClient.generate_ws_connection()` ã¯ï¼š

1. AWSã®èªè¨¼æƒ…å ±ï¼ˆã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ç­‰ï¼‰ã‚’ä½¿ã£ã¦
2. ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ã€Œç½²åã€ã‚’ä»˜ä¸ã—
3. ç½²åä»˜ãã®WebSocket URLã‚’ç”Ÿæˆã™ã‚‹

```
é€šå¸¸ã®URL:
wss://example.com/ws

SigV4ç½²åä»˜ãURL:
wss://example.com/ws?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=...&X-Amz-Signature=abc123...
```

ã“ã®ç½²åãŒã‚ã‚‹ã“ã¨ã§ã€AWSã¯ã€Œæ­£è¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã ã€ã¨åˆ¤æ–­ã§ãã‚‹ã€‚

### 5.5 ãƒ¡ã‚¤ãƒ³ã®éŸ³å£°ã‚»ãƒƒã‚·ãƒ§ãƒ³

```python
async def audio_session(region: str, runtime_arn: str):
    """ãƒã‚¤ã‚¯å…¥åŠ›ã‚’ä½¿ã£ãŸéŸ³å£°å¯¾è©±ã‚»ãƒƒã‚·ãƒ§ãƒ³"""

    # ... çœç•¥ï¼ˆåˆæœŸåŒ–å‡¦ç†ï¼‰...

    recorder = AudioRecorder()
    player = AudioPlayer()

    try:
        async with websockets.connect(
            ws_url,
            additional_headers=headers,  # SigV4èªè¨¼ãƒ˜ãƒƒãƒ€ãƒ¼
            open_timeout=60,             # æ¥ç¶šã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ60ç§’
            close_timeout=10,            # åˆ‡æ–­ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ10ç§’
        ) as websocket:

            recorder.start()  # éŒ²éŸ³é–‹å§‹

            # é€ä¿¡ã‚¿ã‚¹ã‚¯ã¨å—ä¿¡ã‚¿ã‚¹ã‚¯ã‚’ä¸¦è¡Œå®Ÿè¡Œ
            send_task = asyncio.create_task(send_audio(websocket, recorder))
            receive_task = asyncio.create_task(receive_messages(websocket, player))

            # ã©ã¡ã‚‰ã‹ãŒçµ‚äº†ã™ã‚‹ã¾ã§å¾…æ©Ÿ
            done, pending = await asyncio.wait(
                [send_task, receive_task],
                return_when=asyncio.FIRST_COMPLETED
            )
```

#### async with ã®æ„å‘³

```python
async with websockets.connect(...) as websocket:
    # ã“ã®ä¸­ã§websocketã‚’ä½¿ã†
# ã“ã“ã«æ¥ã‚‹ã¨è‡ªå‹•çš„ã«æ¥ç¶šãŒé–‰ã˜ã‚‰ã‚Œã‚‹
```

`with` æ–‡ã¯ã€Œå¾Œç‰‡ä»˜ã‘ã‚’è‡ªå‹•ã§ã‚„ã£ã¦ãã‚Œã‚‹ã€ä»•çµ„ã¿ã€‚
æ¥ç¶šã‚’é–‹ã„ã¦ã€ãƒ–ãƒ­ãƒƒã‚¯ã‚’æŠœã‘ã‚‹ã¨è‡ªå‹•ã§é–‰ã˜ã‚‹ã€‚

#### asyncio.create_task

```python
send_task = asyncio.create_task(send_audio(...))
receive_task = asyncio.create_task(receive_messages(...))
```

2ã¤ã®å‡¦ç†ã‚’ã€ŒåŒæ™‚ã«ã€é–‹å§‹ã™ã‚‹ã€‚

```
create_taskå‰:
send_audio â†’ çµ‚ã‚ã‚‹ã¾ã§å¾…ã¤ â†’ receive_messages

create_taskå¾Œ:
send_audio    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’
receive_messages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’
ï¼ˆä¸¡æ–¹åŒæ™‚ã«å‹•ãï¼‰
```

#### asyncio.wait

```python
done, pending = await asyncio.wait(
    [send_task, receive_task],
    return_when=asyncio.FIRST_COMPLETED
)
```

ã€Œã©ã¡ã‚‰ã‹ãŒçµ‚ã‚ã‚‹ã¾ã§å¾…ã¤ã€ã¨ã„ã†æ„å‘³ã€‚

- `done`: çµ‚äº†ã—ãŸã‚¿ã‚¹ã‚¯ã®é›†åˆ
- `pending`: ã¾ã å®Ÿè¡Œä¸­ã®ã‚¿ã‚¹ã‚¯ã®é›†åˆ

ä¾‹ãˆã°ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒCtrl+Cã‚’æŠ¼ã™ã¨ receive_task ãŒã‚¨ãƒ©ãƒ¼ã§çµ‚äº†ã—ã€
ãã®æ™‚ç‚¹ã§ wait ã‹ã‚‰æŠœã‘ã¦ã€æ®‹ã‚Šã® send_task ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã™ã‚‹ã€‚

### 5.6 éŸ³å£°é€ä¿¡å‡¦ç†

```python
async def send_audio(websocket, recorder: AudioRecorder):
    """ãƒã‚¤ã‚¯ã‹ã‚‰ã®éŸ³å£°ã‚’WebSocketã«é€ä¿¡"""
    try:
        while True:
            # ã‚­ãƒ¥ãƒ¼ã‹ã‚‰éŸ³å£°ãƒãƒ£ãƒ³ã‚¯ã‚’å–å¾—
            audio_chunk = recorder.get_audio_chunk()

            if audio_chunk:
                # BidiAudioInputEventå½¢å¼ã§é€ä¿¡
                message = {
                    "type": "bidi_audio_input",
                    "audio": base64.b64encode(audio_chunk).decode("utf-8"),
                    "format": "pcm",
                    "sample_rate": INPUT_SAMPLE_RATE,
                    "channels": CHANNELS
                }
                await websocket.send(json.dumps(message))

            # å°‘ã—å¾…æ©Ÿï¼ˆCPUè² è·è»½æ¸›ï¼‰
            await asyncio.sleep(0.01)
```

#### å‡¦ç†ã®æµã‚Œ

```
1. recorder.get_audio_chunk()
   ã‚­ãƒ¥ãƒ¼ã‹ã‚‰éŒ²éŸ³ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—

2. base64.b64encode(audio_chunk)
   ãƒã‚¤ãƒŠãƒª â†’ ãƒ†ã‚­ã‚¹ãƒˆå¤‰æ›

3. .decode("utf-8")
   ãƒã‚¤ãƒˆæ–‡å­—åˆ— â†’ æ–‡å­—åˆ—ã«å¤‰æ›

4. json.dumps(message)
   è¾æ›¸ â†’ JSONæ–‡å­—åˆ—ã«å¤‰æ›

5. websocket.send(...)
   ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡
```

#### await asyncio.sleep(0.01)

10ãƒŸãƒªç§’å¾…æ©Ÿã€‚ã“ã‚ŒãŒãªã„ã¨ï¼š
- CPUãŒ100%ã«ãªã‚‹ï¼ˆç„¡é™ãƒ«ãƒ¼ãƒ—ã‚’å…¨é€ŸåŠ›ã§å›ã™ãŸã‚ï¼‰
- ä»–ã®ã‚¿ã‚¹ã‚¯ï¼ˆå—ä¿¡ï¼‰ã«å‡¦ç†ãŒå›ã‚‰ãªã„

ã€Œã¡ã‚‡ã£ã¨ä¼‘æ†©ã—ã¦ã€ä»–ã®äººã«ã‚‚é †ç•ªã‚’è­²ã‚‹ã€ã¨ã„ã†ã‚¤ãƒ¡ãƒ¼ã‚¸ã€‚

### 5.7 éŸ³å£°å—ä¿¡å‡¦ç†

```python
async def receive_messages(websocket, player: AudioPlayer):
    """WebSocketã‹ã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡ã—ã¦å‡¦ç†"""
    try:
        async for message in websocket:  # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒæ¥ã‚‹ãŸã³ã«ãƒ«ãƒ¼ãƒ—
            data = json.loads(message)   # JSON â†’ è¾æ›¸
            msg_type = data.get("type", "")

            # éŸ³å£°ã‚¹ãƒˆãƒªãƒ¼ãƒ 
            if msg_type == "bidi_audio_stream":
                audio_data = data.get("audio", "")
                if audio_data:
                    audio_bytes = base64.b64decode(audio_data)  # ãƒ†ã‚­ã‚¹ãƒˆ â†’ ãƒã‚¤ãƒŠãƒª
                    player.play(audio_bytes)  # å†ç”Ÿ

            # ãƒˆãƒ©ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆæ–‡å­—èµ·ã“ã—ï¼‰
            elif msg_type == "bidi_transcript_stream":
                role = data.get("role", "")
                text = data.get("text", "")
                is_final = data.get("is_final", False)
                if is_final:
                    prefix = "Agent" if role == "assistant" else "You"
                    print(f"[{prefix}] {text}")
```

#### async for message in websocket

WebSocketã‹ã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå±ŠããŸã³ã«ã€ãƒ«ãƒ¼ãƒ—ãŒ1å›å®Ÿè¡Œã•ã‚Œã‚‹ã€‚

```
ã‚µãƒ¼ãƒãƒ¼ â†’ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸1 â†’ ãƒ«ãƒ¼ãƒ—1å›ç›®
ã‚µãƒ¼ãƒãƒ¼ â†’ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸2 â†’ ãƒ«ãƒ¼ãƒ—2å›ç›®
ã‚µãƒ¼ãƒãƒ¼ â†’ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸3 â†’ ãƒ«ãƒ¼ãƒ—3å›ç›®
...
```

ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒãªã„é–“ã¯ã€Œå¾…æ©Ÿã€çŠ¶æ…‹ã«ãªã‚Šã€CPUã‚’æ¶ˆè²»ã—ãªã„ã€‚

---

## 6. éåŒæœŸå‡¦ç†ã®ä»•çµ„ã¿

### ãªãœéåŒæœŸå‡¦ç†ãŒå¿…è¦ã‹

éŸ³å£°é€šè©±ã§ã¯ã€ä»¥ä¸‹ãŒã€ŒåŒæ™‚ã«ã€èµ·ãã‚‹å¿…è¦ãŒã‚ã‚‹ï¼š

1. ãƒã‚¤ã‚¯ã‹ã‚‰éŒ²éŸ³ï¼ˆé€£ç¶šçš„ã«ï¼‰
2. éŒ²éŸ³ãƒ‡ãƒ¼ã‚¿ã‚’ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ï¼ˆé€£ç¶šçš„ã«ï¼‰
3. ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®è¿”ç­”ã‚’å—ä¿¡ï¼ˆã„ã¤æ¥ã‚‹ã‹ã‚ã‹ã‚‰ãªã„ï¼‰
4. å—ä¿¡ã—ãŸéŸ³å£°ã‚’å†ç”Ÿï¼ˆé€£ç¶šçš„ã«ï¼‰

ã“ã‚Œã‚’æ™®é€šã®ã€Œé †ç•ªã«å‡¦ç†ã€ã§æ›¸ãã¨ï¼š

```python
# ãƒ€ãƒ¡ãªä¾‹
while True:
    audio = record()      # éŒ²éŸ³ï¼ˆ100msï¼‰
    send(audio)           # é€ä¿¡ï¼ˆ50msï¼‰
    response = receive()  # å—ä¿¡ï¼ˆå¾…ã¡æ™‚é–“ä¸å®šï¼‰
    play(response)        # å†ç”Ÿï¼ˆ100msï¼‰
```

å•é¡Œç‚¹ï¼š
- `receive()` ã§ã‚µãƒ¼ãƒãƒ¼ã®è¿”ç­”ã‚’å¾…ã£ã¦ã„ã‚‹é–“ã€éŒ²éŸ³ãŒã§ããªã„
- ä¼šè©±ãŒé€”åˆ‡ã‚Œé€”åˆ‡ã‚Œã«ãªã‚‹

### async/await ã®åŸºæœ¬

```python
async def my_function():     # éåŒæœŸé–¢æ•°ã®å®šç¾©
    result = await some_io() # I/Oå‡¦ç†ã‚’ã€Œå¾…ã¤ã€ï¼ˆã§ã‚‚ä»–ã®å‡¦ç†ã¯é€²ã‚€ï¼‰
    return result
```

`await` ã¯ã€Œã“ã®å‡¦ç†ãŒçµ‚ã‚ã‚‹ã¾ã§å¾…ã¤ã‘ã©ã€ãã®é–“ã«ä»–ã®ã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œã—ã¦ã„ã„ã‚ˆã€ã¨ã„ã†æ„å‘³ã€‚

```
å¾“æ¥ã®wait:
ã‚¿ã‚¹ã‚¯A: å‡¦ç†ä¸­... å¾…æ©Ÿ... å¾…æ©Ÿ... å¾…æ©Ÿ... å†é–‹
ã‚¿ã‚¹ã‚¯B: ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€é–‹å§‹ï¼ˆAãŒçµ‚ã‚ã‚‹ã¾ã§å§‹ã‚ã‚‰ã‚Œãªã„ï¼‰

asyncã®await:
ã‚¿ã‚¹ã‚¯A: å‡¦ç†ä¸­... awaitï¼ˆå¾…æ©Ÿï¼‰
ã‚¿ã‚¹ã‚¯B: ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€é–‹å§‹... å‡¦ç†ä¸­... await
ã‚¿ã‚¹ã‚¯A: ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€å†é–‹... å®Œäº†
ã‚¿ã‚¹ã‚¯B: ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€å†é–‹... å®Œäº†
```

### ã“ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§ã®éåŒæœŸå‡¦ç†

```python
# 2ã¤ã®ã‚¿ã‚¹ã‚¯ã‚’ä½œæˆ
send_task = asyncio.create_task(send_audio(...))      # é€ä¿¡ã‚¿ã‚¹ã‚¯
receive_task = asyncio.create_task(receive_messages(...))  # å—ä¿¡ã‚¿ã‚¹ã‚¯

# ä¸¡æ–¹ã‚’ã€ŒåŒæ™‚ã«ã€å®Ÿè¡Œé–‹å§‹
await asyncio.wait([send_task, receive_task], ...)
```

```
send_audio:
  while True:
    chunk = get_chunk()        # ã™ãçµ‚ã‚ã‚‹
    await websocket.send(...)  # é€ä¿¡ä¸­ã¯ä»–ã®ã‚¿ã‚¹ã‚¯ã«è­²ã‚‹
    await asyncio.sleep(0.01)  # å°‘ã—å¾…ã¤ï¼ˆä»–ã®ã‚¿ã‚¹ã‚¯ã«è­²ã‚‹ï¼‰

receive_messages:
  async for message in websocket:  # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å¾…ã¡ï¼ˆä»–ã®ã‚¿ã‚¹ã‚¯ã«è­²ã‚‹ï¼‰
    player.play(...)               # å†ç”Ÿï¼ˆã™ãçµ‚ã‚ã‚‹ï¼‰
```

`await` ã®ç¬é–“ã«ã€Œä»–ã®ã‚¿ã‚¹ã‚¯ã«å‡¦ç†ã‚’è­²ã‚‹ã€ã®ã§ã€
send ã¨ receive ãŒäº¤äº’ã«ï¼ˆå®Ÿè³ªåŒæ™‚ã«ï¼‰å‹•ãã€‚

---

## 7. ã‚¤ãƒ™ãƒ³ãƒˆå½¢å¼ã®è©³ç´°

### ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ â†’ ã‚µãƒ¼ãƒãƒ¼ï¼ˆå…¥åŠ›ã‚¤ãƒ™ãƒ³ãƒˆï¼‰

#### BidiAudioInputEventï¼ˆéŸ³å£°å…¥åŠ›ï¼‰

```json
{
  "type": "bidi_audio_input",
  "audio": "SGVsbG8gV29ybGQ=",
  "format": "pcm",
  "sample_rate": 16000,
  "channels": 1
}
```

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | å‹ | èª¬æ˜ |
|-----------|-----|------|
| type | string | ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ï¼ˆå›ºå®šå€¤ï¼‰ |
| audio | string | Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸéŸ³å£°ãƒ‡ãƒ¼ã‚¿ |
| format | string | éŸ³å£°å½¢å¼ï¼ˆ"pcm"ï¼‰ |
| sample_rate | number | ã‚µãƒ³ãƒ—ãƒ«ãƒ¬ãƒ¼ãƒˆï¼ˆ16000ï¼‰ |
| channels | number | ãƒãƒ£ãƒ³ãƒãƒ«æ•°ï¼ˆ1ï¼‰ |

#### BidiTextInputEventï¼ˆãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ï¼‰

```json
{
  "type": "bidi_text_input",
  "text": "ã“ã‚“ã«ã¡ã¯",
  "role": "user"
}
```

### ã‚µãƒ¼ãƒãƒ¼ â†’ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆå‡ºåŠ›ã‚¤ãƒ™ãƒ³ãƒˆï¼‰

#### BidiAudioStreamEventï¼ˆéŸ³å£°å‡ºåŠ›ï¼‰

```json
{
  "type": "bidi_audio_stream",
  "audio": "SGVsbG8gV29ybGQ=",
  "format": "pcm",
  "sample_rate": 16000,
  "channels": 1
}
```

#### BidiTranscriptStreamEventï¼ˆæ–‡å­—èµ·ã“ã—ï¼‰

```json
{
  "type": "bidi_transcript_stream",
  "role": "user",
  "text": "ã“ã‚“ã«ã¡ã¯",
  "is_final": true
}
```

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | å‹ | èª¬æ˜ |
|-----------|-----|------|
| role | string | è©±è€…ï¼ˆ"user" ã¾ãŸã¯ "assistant"ï¼‰ |
| text | string | èªè­˜/ç”Ÿæˆã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆ |
| is_final | boolean | ç¢ºå®šã—ãŸã‹ã©ã†ã‹ |

`is_final: false` ã®é–“ã¯é€”ä¸­çµŒéï¼ˆã¾ã å¤‰ã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ï¼‰ã€‚
`is_final: true` ã«ãªã£ãŸã‚‰ç¢ºå®šã€‚

#### ãã®ä»–ã®ã‚¤ãƒ™ãƒ³ãƒˆ

| ã‚¤ãƒ™ãƒ³ãƒˆ | æ„å‘³ |
|---------|------|
| bidi_connection_start | æ¥ç¶šãŒç¢ºç«‹ã•ã‚ŒãŸ |
| bidi_response_start | AIãŒè¿”ç­”ã‚’é–‹å§‹ã—ãŸ |
| bidi_response_complete | AIã®è¿”ç­”ãŒå®Œäº†ã—ãŸ |
| bidi_error | ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸ |
| bidi_usage | ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡ï¼ˆèª²é‡‘æƒ…å ±ï¼‰ |
| tool_use_stream | AIãŒãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ãŸ |

---

## 8. ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### éŸ³å£°ãŒèã“ãˆãªã„

**åŸå› 1: ã‚µãƒ³ãƒ—ãƒ«ãƒ¬ãƒ¼ãƒˆã®ä¸ä¸€è‡´**

```
ã‚µãƒ¼ãƒãƒ¼: 16kHz ã§é€ä¿¡
ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ: 24kHz ã§å†ç”Ÿ
â†’ éŸ³ãŒé«˜ãã€æ—©å£ã«ãªã‚‹

ã‚µãƒ¼ãƒãƒ¼: 24kHz ã§é€ä¿¡
ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ: 16kHz ã§å†ç”Ÿ
â†’ éŸ³ãŒä½ãã€ã‚¹ãƒ­ãƒ¼ã«ãªã‚‹
```

**è§£æ±ºç­–**: `[Audio Format]` ã®ãƒ­ã‚°ã‚’ç¢ºèªã—ã€OUTPUT_SAMPLE_RATE ã‚’åˆã‚ã›ã‚‹

**åŸå› 2: ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ãŒãƒŸãƒ¥ãƒ¼ãƒˆ**

PCã®ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼è¨­å®šã‚’ç¢ºèª

### éŸ³å£°ãŒé€”åˆ‡ã‚Œã‚‹

**åŸå› **: ãƒãƒƒãƒ•ã‚¡ã‚µã‚¤ã‚ºãŒå°ã•ã„

**è§£æ±ºç­–**: `frames_per_buffer` ã‚’å¤§ããã™ã‚‹

```python
self.stream = self.pa.open(
    ...
    frames_per_buffer=CHUNK_SIZE * 4,  # å¤§ããã™ã‚‹
)
```

### æ¥ç¶šãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã™ã‚‹

**åŸå› 1**: AgentCore Runtime ãŒã¾ã èµ·å‹•ã—ã¦ã„ãªã„

**è§£æ±ºç­–**: ãƒ‡ãƒ—ãƒ­ã‚¤çŠ¶æ…‹ã‚’ç¢ºèª
```bash
aws bedrock-agentcore get-runtime --runtime-arn "$AGENT_ARN" --query 'status'
```

**åŸå› 2**: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®å•é¡Œï¼ˆVPNã€ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ç­‰ï¼‰

### èªè¨¼ã‚¨ãƒ©ãƒ¼

**åŸå› **: AWSèªè¨¼æƒ…å ±ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„

**è§£æ±ºç­–**:
```bash
aws configure
# ã¾ãŸã¯
export AWS_PROFILE=your-profile
```

---

## ä»˜éŒ²: ç”¨èªé›†

| ç”¨èª | èª­ã¿æ–¹ | æ„å‘³ |
|-----|-------|------|
| WebSocket | ã‚¦ã‚§ãƒ–ã‚½ã‚±ãƒƒãƒˆ | åŒæ–¹å‘ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šä¿¡ãƒ—ãƒ­ãƒˆã‚³ãƒ« |
| PCM | ãƒ”ãƒ¼ã‚·ãƒ¼ã‚¨ãƒ  | éåœ§ç¸®ã®éŸ³å£°ãƒ‡ãƒ¼ã‚¿å½¢å¼ |
| Sample Rate | ã‚µãƒ³ãƒ—ãƒ«ãƒ¬ãƒ¼ãƒˆ | 1ç§’é–“ã®ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°å›æ•° |
| Mono | ãƒ¢ãƒãƒ©ãƒ« | 1ãƒãƒ£ãƒ³ãƒãƒ«ã®éŸ³å£° |
| Stereo | ã‚¹ãƒ†ãƒ¬ã‚ª | 2ãƒãƒ£ãƒ³ãƒãƒ«ï¼ˆå·¦å³ï¼‰ã®éŸ³å£° |
| Base64 | ãƒ™ãƒ¼ã‚¹ã‚ãã˜ã‚…ã†ã‚ˆã‚“ | ãƒã‚¤ãƒŠãƒªã‚’ãƒ†ã‚­ã‚¹ãƒˆã«å¤‰æ›ã™ã‚‹æ–¹å¼ |
| Callback | ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ | å¾Œã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹é–¢æ•° |
| Queue | ã‚­ãƒ¥ãƒ¼ | å…ˆå…¥ã‚Œå…ˆå‡ºã—ã®ãƒ‡ãƒ¼ã‚¿æ§‹é€  |
| Async | ã‚¢ã‚·ãƒ³ã‚¯ | éåŒæœŸå‡¦ç† |
| Await | ã‚¢ã‚¦ã‚§ã‚¤ãƒˆ | éåŒæœŸå‡¦ç†ã®å®Œäº†ã‚’å¾…ã¤ |
| SigV4 | ã‚·ã‚°ãƒ–ã‚¤ãƒ•ã‚©ãƒ¼ | AWSã®ç½²åèªè¨¼æ–¹å¼ |
| ARN | ã‚¨ãƒ¼ã‚¢ãƒ¼ãƒ«ã‚¨ãƒŒ | AWSãƒªã‚½ãƒ¼ã‚¹ã®ä¸€æ„ãªè­˜åˆ¥å­ |
| STT | ã‚¨ã‚¹ãƒ†ã‚£ãƒ¼ãƒ†ã‚£ãƒ¼ | Speech-to-Textï¼ˆéŸ³å£°èªè­˜ï¼‰ |
| TTS | ãƒ†ã‚£ãƒ¼ãƒ†ã‚£ãƒ¼ã‚¨ã‚¹ | Text-to-Speechï¼ˆéŸ³å£°åˆæˆï¼‰ |
| Bidi | ãƒã‚¤ãƒ€ã‚¤ | Bidirectionalï¼ˆåŒæ–¹å‘ï¼‰ã®ç•¥ |
| Nova Sonic | ãƒãƒã‚½ãƒ‹ãƒƒã‚¯ | AWSã®éŸ³å£°AIåŸºç›¤ãƒ¢ãƒ‡ãƒ« |

---

## ã¾ã¨ã‚

ã“ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯ã€ä»¥ä¸‹ã®è¦ç´ ã§æ§‹æˆã•ã‚Œã¦ã„ã¾ã™ï¼š

1. **éŸ³å£°å…¥åŠ›**: PyAudio + AudioRecorder ã§ãƒã‚¤ã‚¯ã‹ã‚‰éŒ²éŸ³
2. **ãƒ‡ãƒ¼ã‚¿å¤‰æ›**: Base64 + JSON ã§éŸ³å£°ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ†ã‚­ã‚¹ãƒˆåŒ–
3. **é€šä¿¡**: WebSocket ã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæ–¹å‘é€šä¿¡
4. **èªè¨¼**: SigV4 ã§ AWS ã‚µãƒ¼ãƒ“ã‚¹ã«å®‰å…¨ã«ã‚¢ã‚¯ã‚»ã‚¹
5. **éåŒæœŸå‡¦ç†**: asyncio ã§é€å—ä¿¡ã‚’åŒæ™‚å®Ÿè¡Œ
6. **éŸ³å£°å‡ºåŠ›**: AudioPlayer ã§ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ã‹ã‚‰å†ç”Ÿ

ã“ã‚Œã‚‰ãŒé€£æºã™ã‚‹ã“ã¨ã§ã€AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨ã®è‡ªç„¶ãªéŸ³å£°ä¼šè©±ãŒå®Ÿç¾ã§ãã¾ã™ã€‚
